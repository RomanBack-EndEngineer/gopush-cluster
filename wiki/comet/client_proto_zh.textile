<h3>Terry-Mao/gopush-cluster Comet TCP客户端通讯协议文档</h3>
直接使用Redis的协议格式，方便解析和使用，参考 "Redis 协议":redis_ref 。

<h3>流程图</h3>
 !http://raw.github.com/Terry-Mao/gopush-cluster/master/wiki/comet/client_proto_zh.png(comet protocol)!

<h3>网络层</h3>
协议命令总是以 \r\n(CRLF)结尾。

<h3>请求</h3>
当comet接受订阅命令，如果存在任何错误会返回状态包或主动断开连接，否则会返回响应心跳或者是响应包。
<pre>
==*==参数个数 CR LF
$第一个参数的字符串占用字节数 CR LF
参数数据 CR LF
...
$第N个参数的字符串占用字节数字 CR LF
参数数据 CR LF
</pre>
请求订阅参数列表：

(head). | 字段 | 类型 | 是否必选 | 顺序 | 描述 |
| cmd | string | 是 | 0 | 指令，发起订阅指令为“sub” |
| key | string | 是 | 1 | 用户发起订阅的Key |
| mid | int64 | 是 | 2 | 用户本地保存的“最后收到的消息ID”，如果没有就用0 |
| heartbeat | int | 是 | 3 | 长连接的心跳周期（单位：秒）|
| token | string | 否 | 4 | 验证连接的token |

例如：
<pre>==*==4\r\n$3\r\nsub\r\n$9\r\nTerry-Mao\r\n$1\r\n0\r\n$2\r\n10\r\n</pre>
表示一共有 *4* 个参数的指令，第一个参数表示指令是 *sub* ；第二个参数表示Key是 *Terry-Mao* ；第三个参数表示本地的消息ID是 *0* ；第四个参数表示心跳周期是 *10* 秒；其中指令前面的$num表示指令的字符字节长度，如$3表示sub的订阅指令长度为 *3* 。

<h3>状态</h3>
错误状态的协议首字符都是“-”，例如参数错误、未授权的Channel、Token验证失败等。
<pre>
-p\r\n
-a\r\n
-c\r\n
</pre>
其中p表示参数错误、a表示token验证失败、a表示channel未授权或找不到。

<h3>请求心跳</h3>
心跳包：<pre>h</pre>
客户端定期发送请求心跳给服务端，服务端接受以后，返回响应心跳包。

<h3>响应心跳</h3>
心跳包：<pre>+h\r\n</pre>
服务端接受请求命令包成功以后，返回一个初始响应心跳给客户端，这时候客户端才开始定期发送请求心跳以及接受返回数据。

<h3>响应</h3>
格式参照上面提到的Redis协议来返回reply，
例如：
<pre>$5\r\nTerry\r\n</pre>
其中Terry就是接受到推送的消息内容。

[redis_ref]http://redis.io/topics/protocol
